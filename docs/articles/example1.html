<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="kDGLM">
<title>Space-time model hospital admissions from gastroenteritis â€¢ kDGLM</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Space-time model hospital admissions from gastroenteritis">
<meta property="og:description" content="kDGLM">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">kDGLM</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.2.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/intro.html">Introduction</a>
    <a class="dropdown-item" href="../articles/structures.html">Creation of model structures</a>
    <a class="dropdown-item" href="../articles/outcomes.html">Creation of model outcomes</a>
    <a class="dropdown-item" href="../articles/fitting.html">Fitting and analysing models</a>
    <a class="dropdown-item" href="../articles/example1.html">Space-time model hospital admissions from gastroenteritis</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/silvaneojunior/kDGLM/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Space-time model hospital admissions from gastroenteritis</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/silvaneojunior/kDGLM/blob/HEAD/vignettes/example1.Rmd" class="external-link"><code>vignettes/example1.Rmd</code></a></small>
      <div class="d-none name"><code>example1.Rmd</code></div>
    </div>

    
    
<style>
body {
text-align: justify}
</style>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: { equationNumbers: { autoNumber: "AMS" } }
});
</script><div class="section level2">
<h2 id="table-of-contents">Table of contents<a class="anchor" aria-label="anchor" href="#table-of-contents"></a>
</h2>
<ol>
<li>
<details><summary><a href="intro.html">Introduction:</a> &gt;
</summary><ul>
<li>
<a href="intro.html#introduction">Introduction</a>
</li>
<li>
<a href="intro.html#notation">Notation</a>
</li>
</ul></details>
</li>
<li>
<details><summary><a href="structures.html">Creating the model structure:</a> &gt;
</summary><ul>
<li>
<a href="structures.html#a-structure-for-polynomial-trend-models">A
structure for polynomial trend models</a>
</li>
<li>
<a href="structures.html#a-structure-for-dynamic-regression-models">A
structure for dynamic regression models</a>
</li>
<li>
<a href="structures.html#a-structure-for-harmonic-trend-models">A
structure for harmonic trend models</a>
</li>
<li>
<a href="structures.html#a-structure-for-autoregresive-models">A
structure for autoregresive models</a>
</li>
<li>
<a href="structures.html#a-structure-for-overdispersed-models">A
structure for overdispersed models</a>
</li>
<li>
<a href="structures.html#handling-multiple-structural-blocks">Handling
multiple structural blocks</a>
</li>
<li>
<a href="structures.html#handling-multiple-linear-predictors">Handling
multiple linear predictors</a>
</li>
<li>
<a href="structures.html#handling-unknown-components-in-the-planning-matrix-f_t">Handling
unknown components in the planning matrix <span class="math inline">\(F_t\)</span></a>
</li>
<li>
<a href="structures.html#special-priors">Special priors</a>
</li>
</ul></details>
</li>
<li>
<details><summary><a href="outcomes.html">Creating the model outcome:</a> &gt;
</summary><ul>
<li>
<a href="outcomes.html#normal-case">Normal case</a>
</li>
<li>
<a href="outcomes.html#poisson-case">Poisson case</a>
</li>
<li>
<a href="outcomes.html#gamma-case">Gamma case</a>
</li>
<li>
<a href="outcomes.html#multinomial-case">Multinomial case</a>
</li>
<li>
<a href="outcomes.html#handling-multiple-outcomes">Handling multiple
outcomes</a>
</li>
</ul></details>
</li>
<li>
<details><summary><a href="fitting.html">Fitting and analysing models:</a> &gt;
</summary><ul>
<li>
<a href="fitting.html#filtering-and-smoothing">Filtering and
smoothing</a>
</li>
<li>
<a href="fitting.html#extracting-components">Extracting components</a>
</li>
<li>
<a href="fitting.html#forecasting">Forecasting</a>
</li>
<li>
<a href="fitting.html#intervention-and-monitoring">Intervention and
monitoring</a>
</li>
<li>
<a href="fitting.html#tools-for-sensibility-analysis">Tools for
sensibility analysis</a>
</li>
<li>
<a href="fitting.html#sampling-and-hyper-parameter-estimation">Sampling
and hyper parameter estimation</a>
</li>
</ul></details>
</li>
<li>
<details><summary>
Advanced examples:&gt;
</summary><ul><li>
<a href="example1.html">Space-time model hospital admissions from
gastroenteritis</a>
</li></ul></details>
</li>
</ol>
</div>
<div class="section level2">
<h2 id="applied-example-space-time-model-for-hospital-admissions-from-gastroenteritis">Applied example: Space-time model for hospital admissions from
gastroenteritis<a class="anchor" aria-label="anchor" href="#applied-example-space-time-model-for-hospital-admissions-from-gastroenteritis"></a>
</h2>
<p>In this example we model number of hospital admissions from
gastroenteritis in Brazil from 2010 to 2022 <span class="citation">(<a href="#ref-datasus_data">Ministry of Health, Brazil, 2023</a>)</span>.
The <strong>kDGLM</strong> package provides the <code>gatroBR</code>
dataset with the pertinent data for our models, which includes:</p>
<ul>
<li>UF: The abbreviated state name.</li>
<li>Date: The date of the observation. Note that the day is only a
placeholder, as we are dealing with monthly reports.</li>
<li>Admissions: The number hospital admissions that were reported in
that combination of state and date.</li>
<li>Population: The estimated population in that combination of state
and date (to be used as a offset).</li>
</ul>
<p>Supplementary information can be found in the documentation (see
<code><a href="../reference/gastroBR.html">help(gastroBR)</a></code>)).</p>
</div>
<div class="section level2">
<h2 id="initial-model-total-hospital-admissions">Initial model: Total hospital admissions<a class="anchor" aria-label="anchor" href="#initial-model-total-hospital-admissions"></a>
</h2>
<p>We start the analysis with a model for the total number of hospital
admissions over time in Brazil, i.e., a temporal model that does not
consider the hospital admissions on each state.</p>
<p><img src="example1_files/figure-html/unnamed-chunk-2-1.png" width="672"></p>
<p>From the figure above we can see that there is a consistent trend of
(log) linear decay of the rate of hospital admissions over time, until
April of 2020, when there is an abrupt reduction of hospital admission
due to the pandemic of COVID-19 <span class="citation">(<a href="#ref-covid_reduc">Ribeiro et al., 2022</a>)</span>, which is then
followed by what seems to be a return to the previous level, although
more observations would be necessary to be sure. We can also note that
the data has a clear seasonal pattern, with a period of <span class="math inline">\(12\)</span> months.</p>
<p>We begin with a very simply model. Let <span class="math inline">\(Y_t\)</span> be the total number of hospital
admissions on Brazil at time <span class="math inline">\(t\)</span>.
Assume that:</p>
<p><span class="math display">\[
\begin{aligned}
Y_t|\eta_t &amp;\sim Poisson(\eta_t)\\
\ln{\eta_t}&amp;=\lambda_t=\theta_{1,t}\\
\theta_{1,t}&amp;=\theta_{1,t-1}+\theta_{2,t-1}+\omega_{1,t}\\
\theta_{2,t}&amp;=\theta_{2,t-1}+\omega_{2,t}.\\
\end{aligned}
\]</span></p>
<p>First we define the model structure:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">structure</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/polynomial_block.html">polynomial_block</a></span><span class="op">(</span></span>
<span>  rate <span class="op">=</span> <span class="fl">1</span>, order <span class="op">=</span> <span class="fl">2</span>, D <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.95</span>, <span class="fl">0.975</span><span class="op">)</span>,</span>
<span>  name <span class="op">=</span> <span class="st">"Trend"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Then we define the outcome:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">outcome</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Poisson.html">Poisson</a></span><span class="op">(</span></span>
<span>  lambda <span class="op">=</span> <span class="st">"rate"</span>,</span>
<span>  data <span class="op">=</span> <span class="va">data.year</span><span class="op">$</span><span class="va">Admissions</span>,</span>
<span>  offset <span class="op">=</span> <span class="va">data.year</span><span class="op">$</span><span class="va">Population</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Then we fit the model:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fitted.model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_model.html">fit_model</a></span><span class="op">(</span><span class="va">structure</span>, <span class="va">outcome</span><span class="op">)</span></span></code></pre></div>
<p>Finally, we can see how our model performed with the and methods:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fitted.model</span><span class="op">)</span></span></code></pre></div>
<pre><code>Fitted DGLM with 1 outcomes.

distributions:
    Series.1: Poisson

---
No static coeficients.
---
See the coef.fitted_dlm for the coeficients with temporal dynamic.

One-step-ahead prediction
Log-likelihood        : -24560.92
Interval Score        :   52492.80142
Mean Abs. Scaled Error:       1.41602
---</code></pre>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fitted.model</span>, plot.pkg <span class="op">=</span> <span class="st">"base"</span><span class="op">)</span></span></code></pre></div>
<p><img src="example1_files/figure-html/unnamed-chunk-6-1.png" width="672"></p>
<p>Clearly the model described above is too simple to describe the data.
In particular, it does not take into account any form of seasonal
pattern. Let us proceed then by assuming the following model:</p>
<p><span class="math display">\[
\begin{aligned}
Y_t|\eta_t &amp;\sim Poisson(\eta_t)\\
\ln{\eta_t}&amp;=\lambda_t=\theta_{1,t}+\theta_{3,t}\\
\theta_{1,t}&amp;=\theta_{1,t-1}+\theta_{2,t-1}+\omega_{1,t}\\
\theta_{2,t}&amp;=\theta_{2,t-1}+\omega_{2,t},\\
\begin{bmatrix}\theta_{3,t}\\\theta_{4,t}\end{bmatrix}&amp;=R\begin{bmatrix}\theta_{3,t}\\\theta_{4,t}\end{bmatrix}+\begin{bmatrix}\omega_{3,t}\\\omega_{4,t}\end{bmatrix}\\
R&amp;=\begin{bmatrix}
\cos(\frac{2\pi}{12})  &amp;\sin(\frac{2\pi}{12})\\
-\sin(\frac{2\pi}{12}) &amp; \cos(\frac{2\pi}{12})\end{bmatrix}
\end{aligned}
\]</span></p>
<p>Where <span class="math inline">\(R\)</span> is a rotation matrix
with angle <span class="math inline">\(\frac{2\pi}{12}\)</span>, such
that <span class="math inline">\(R^{12}\)</span> is equal to the
identity matrix.</p>
<p>To define the structure of that model we can use the
<code>harmonic_block</code> function alongside the
<code>polynomial_block</code> function:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">structure</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/polynomial_block.html">polynomial_block</a></span><span class="op">(</span></span>
<span>  rate <span class="op">=</span> <span class="fl">1</span>, order <span class="op">=</span> <span class="fl">2</span>, D <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.95</span>, <span class="fl">0.975</span><span class="op">)</span>,</span>
<span>  name <span class="op">=</span> <span class="st">"Trend"</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/harmonic_block.html">harmonic_block</a></span><span class="op">(</span></span>
<span>    rate <span class="op">=</span> <span class="fl">1</span>, period <span class="op">=</span> <span class="fl">12</span>, D <span class="op">=</span> <span class="fl">0.98</span>,</span>
<span>    name <span class="op">=</span> <span class="st">"Season"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>Then we fit the model (using the previously defined outcome):</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fitted.model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_model.html">fit_model</a></span><span class="op">(</span><span class="va">structure</span>, <span class="va">outcome</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fitted.model</span><span class="op">)</span></span></code></pre></div>
<pre><code>Fitted DGLM with 1 outcomes.

distributions:
    Series.1: Poisson

---
No static coeficients.
---
See the coef.fitted_dlm for the coeficients with temporal dynamic.

One-step-ahead prediction
Log-likelihood        : -17339.1
Interval Score        :   41481.46809
Mean Abs. Scaled Error:       0.70882
---</code></pre>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fitted.model</span>, plot.pkg <span class="op">=</span> <span class="st">"base"</span><span class="op">)</span></span></code></pre></div>
<p><img src="example1_files/figure-html/unnamed-chunk-9-1.png" width="672"></p>
<p>Notice that this change significantly improves all metrics provided
by the model summary, which indicates that we are going in the right
direction. We encourage the reader to test different orders for the
harmonic block.</p>
<p>The previous model could capture the mean behavior of the series
reasonably well. However, two deficiencies of that model standout:
first, the overconfidence in the predictions, evidenced by the
particularly thin credibility interval; nnd second, the difficulty the
model had to adapt to the pandemic period.</p>
<p>The first problem comes from the fact that we are using a Poisson
model, which implies that <span class="math inline">\(Var[Y_t|\eta_t]=\mathbb{E}[Y_t|\eta_t]\)</span>,
which means that <span class="math inline">\(Var[Y_t]=\mathbb{E}[Var[Y_t|\eta_t]]+Var[\mathbb{E}[Y_t|\eta_t]]=\mathbb{E}[\eta_t]+Var[\eta_t]\)</span>.
For latter observations we expect <span class="math inline">\(Var[\eta_t]\)</span> to be relatively small; as
such, the variance of <span class="math inline">\(Y_t\)</span> should be
very close to its mean after a reasonable amount of observations. In
this scenario, the coefficient of variation, defined as <span class="math inline">\(\frac{\sqrt{Var[Y_t]}}{\mathbb{E}[Y_t]}\)</span>
goes to <span class="math inline">\(0\)</span> as <span class="math inline">\(\mathbb{E}[Y_t]\)</span> grows, in particular, for
data in the scale we are working with in this particular problem, we
would expect a very low coefficient of variation if the Poisson model
were adequate, but that is not what we observe. This phenomena is called
and is a well known problem in literature . To solve it, we can include
a block representing a white noise that is added to the linear predictor
at each time, but does not affect previous or future observation, so as
to capture the overdipersion. In this case, we will assume the following
model:</p>
<p><span class="math display">\[
\begin{aligned}
Y_t|\eta_t &amp;\sim Poisson(\eta_t)\\
\ln{\eta_t}&amp;=\lambda_t=\theta_{1,t}+\theta_{3,t}+\epsilon_t\\
\theta_{1,t}&amp;=\theta_{1,t-1}+\theta_{2,t-1}+\omega_{1,t}\\
\theta_{2,t}&amp;=\theta_{2,t-1}+\omega_{2,t},\\
\begin{bmatrix}\theta_{3,t}\\\theta_{4,t}\end{bmatrix}&amp;=R\begin{bmatrix}\theta_{3,t}\\\theta_{4,t}\end{bmatrix}+\begin{bmatrix}\omega_{3,t}\\\omega_{4,t}\end{bmatrix}\\
\epsilon_t &amp; \sim \mathcal{N}(0,\sigma_t^2)
\end{aligned}
\]</span></p>
<p>This structure can be defined using the function, alongside the
previously used functions:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">structure</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/polynomial_block.html">polynomial_block</a></span><span class="op">(</span></span>
<span>  rate <span class="op">=</span> <span class="fl">1</span>, order <span class="op">=</span> <span class="fl">2</span>, D <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.95</span>, <span class="fl">0.975</span><span class="op">)</span>,</span>
<span>  name <span class="op">=</span> <span class="st">"Trend"</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/harmonic_block.html">harmonic_block</a></span><span class="op">(</span></span>
<span>    rate <span class="op">=</span> <span class="fl">1</span>, period <span class="op">=</span> <span class="fl">12</span>, D <span class="op">=</span> <span class="fl">0.98</span>,</span>
<span>    name <span class="op">=</span> <span class="st">"Season"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/noise_block.html">noise_block</a></span><span class="op">(</span>rate <span class="op">=</span> <span class="fl">1</span>, name <span class="op">=</span> <span class="st">"Noise"</span><span class="op">)</span></span></code></pre></div>
<p>For the second problem, that of slow adaptation after the start of
the pandemic. The ideal approach would be to make an intervention,
increasing the uncertainty about the latent states at the beginning of
the pandemic period and allowing our model to quickly adapt to the new
scenario <span class="citation">(see <a href="#ref-WestHarr-DLM">West
and Harrison, 1997, Chapter 11</a>)</span>. We recommend this approach
when we already expect a change of behavior in a certain time, even
before looking at the data (which is exactly the case). Still, for
didactic purposes, we will first present how the automated monitoring
can also be used to solve this same problem. In general, we recommend
the automated monitoring approach when we do <strong>not</strong> known
if or <strong>when</strong> a change of behavior happened before looking
at the data, i.e., we do not known of any particular event that we
expect to impact our outcome.</p>
<p>Following what was presented in the Subsection <a href="fitting.html#intervention-and-monitoring">Intervention and
monitoring</a>, we can use the following code to fit our model:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">structure</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/polynomial_block.html">polynomial_block</a></span><span class="op">(</span></span>
<span>  rate <span class="op">=</span> <span class="fl">1</span>, order <span class="op">=</span> <span class="fl">2</span>, D <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.95</span>, <span class="fl">0.975</span><span class="op">)</span>,</span>
<span>  name <span class="op">=</span> <span class="st">"Trend"</span>, monitoring <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">TRUE</span>, <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/harmonic_block.html">harmonic_block</a></span><span class="op">(</span></span>
<span>    rate <span class="op">=</span> <span class="fl">1</span>, period <span class="op">=</span> <span class="fl">12</span>, D <span class="op">=</span> <span class="fl">0.98</span>,</span>
<span>    name <span class="op">=</span> <span class="st">"Season"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/noise_block.html">noise_block</a></span><span class="op">(</span>rate <span class="op">=</span> <span class="fl">1</span>, name <span class="op">=</span> <span class="st">"Noise"</span><span class="op">)</span></span></code></pre></div>
<p>Notice that we set the <code>monitoring</code> of the
<code>polynomial_block</code> to <code>c(TRUE,TRUE)</code>. By default,
the <code>polynomial_block</code> function only activates the monitoring
of its first component (the level), but, by the visual analysis made at
the beginning, it is clear that the pandemic affected both the level and
the slope of the average number of hospital admissions, as such, we
would like to monitor both parameters.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># To activate the automated monitoring it is enough to set the p.monit argument to a valid value</span></span>
<span><span class="va">fitted.model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_model.html">fit_model</a></span><span class="op">(</span><span class="va">structure</span>, <span class="va">outcome</span>, p.monit <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fitted.model</span><span class="op">)</span></span></code></pre></div>
<pre><code>Fitted DGLM with 1 outcomes.

distributions:
    Series.1: Poisson

---
No static coeficients.
---
See the coef.fitted_dlm for the coeficients with temporal dynamic.

One-step-ahead prediction
Log-likelihood        : -1283.634
Interval Score        :   14965.54610
Mean Abs. Scaled Error:       0.71239
---</code></pre>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fitted.model</span>, plot.pkg <span class="op">=</span> <span class="st">"base"</span><span class="op">)</span></span></code></pre></div>
<p><img src="example1_files/figure-html/unnamed-chunk-12-1.png" width="672"></p>
<p>The summary presented above shows a massive improvement in the
comparison metrics with the new changes introduced. Moreover, we can see
that the automated monitoring detected the exact moment where the series
<span class="math inline">\(Y_t\)</span> changed behavior, which allowed
the model to immediately adapt to the pandemic period.</p>
<p>One aspect of the model that may bother the reader is the exceedingly
high uncertainty at the first observations. This behavior is duo to our
approach to the estimation of the variance of the white noise introduced
by the <code>noise_block</code> function <span class="citation">(see <a href="#ref-ArtigoMultivar">dos Santos et al., 2024</a> and the
associated documentation for details)</span>, which can be a bit too
sensitive to bad prior specification at the initial steps. As such, we
highly recommend the user to perform a sensitivity analysis to choose
the initial variance of the white noise:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">structure</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/polynomial_block.html">polynomial_block</a></span><span class="op">(</span></span>
<span>  rate <span class="op">=</span> <span class="fl">1</span>, order <span class="op">=</span> <span class="fl">2</span>, D <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.95</span>, <span class="fl">0.975</span><span class="op">)</span>,</span>
<span>  name <span class="op">=</span> <span class="st">"Trend"</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/harmonic_block.html">harmonic_block</a></span><span class="op">(</span></span>
<span>    rate <span class="op">=</span> <span class="fl">1</span>, period <span class="op">=</span> <span class="fl">12</span>, D <span class="op">=</span> <span class="fl">0.98</span>,</span>
<span>    name <span class="op">=</span> <span class="st">"Season"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/noise_block.html">noise_block</a></span><span class="op">(</span>rate <span class="op">=</span> <span class="fl">1</span>, R1 <span class="op">=</span> <span class="st">"H"</span>, name <span class="op">=</span> <span class="st">"Noise"</span><span class="op">)</span> <span class="co"># Setting the initial variance as a unknown parameter</span></span>
<span></span>
<span><span class="va">structure</span> <span class="op">&lt;-</span> <span class="va">structure</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/intervention.html">intervention</a></span><span class="op">(</span>time <span class="op">=</span> <span class="fl">124</span>, var.index <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span>, D <span class="op">=</span> <span class="fl">0.005</span><span class="op">)</span></span>
<span></span>
<span><span class="va">search.model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_model.html">fit_model</a></span><span class="op">(</span></span>
<span>  <span class="va">structure</span>, <span class="va">outcome</span>,</span>
<span>  lag <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, <span class="co"># Using the model likelihood (f(y|M)) as the comparisson metric.</span></span>
<span>  H <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq.int</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.1</span>, l <span class="op">=</span> <span class="fl">101</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">fitted.model</span> <span class="op">&lt;-</span> <span class="va">search.model</span><span class="op">$</span><span class="va">model</span></span></code></pre></div>
<p>Notice that, this time around, we chose to make an intervention at
the beginning of the pandemic, instead of an automated approach. As
mentioned before, this approach is preferable in this scenario, since we
were aware that the pandemic would affect our outcome before even
looking at the data.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fitted.model</span><span class="op">)</span></span></code></pre></div>
<pre><code>Fitted DGLM with 1 outcomes.

distributions:
    Series.1: Poisson

---
No static coeficients.
---
See the coef.fitted_dlm for the coeficients with temporal dynamic.

One-step-ahead prediction
Log-likelihood        : -1220.102
Interval Score        :    7470.8794
Mean Abs. Scaled Error:       0.5993
---</code></pre>
<p>Again, the new changes improve the comparison metrics even further,
leading to the conclusion that our last model is the best among those
presented until now. We highly encourage the reader to run this example
and experiment with some of the options the <strong>kDGLM</strong>
package offers, but that were not explored, such as changing the
discount factors used in each block, the order of the blocks,
adding/removing structural components, etc..</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fitted.model</span>, plot.pkg <span class="op">=</span> <span class="st">"base"</span><span class="op">)</span></span></code></pre></div>
<p><img src="example1_files/figure-html/unnamed-chunk-15-1.png" width="672"></p>
<p>As a last side note, the user may not like the approach of choosing a
specific value for the initial variance of the white noise introduced by
the <code>noise_block</code>. Indeed, one may wish to define a prior
distribution for this parameter and estimate it along with the others.
While we will not detail this approach for the sake of brevity (since it
is not directly supported), we would like to point out that we do offer
tools to facilitate this procedure:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">search.result</span> <span class="op">&lt;-</span> <span class="va">search.model</span><span class="op">$</span><span class="va">search.data</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">search.model</span><span class="op">$</span><span class="va">search.data</span><span class="op">$</span><span class="va">H</span><span class="op">)</span>, <span class="op">]</span></span>
<span></span>
<span><span class="va">H.vals</span> <span class="op">&lt;-</span> <span class="va">search.result</span><span class="op">$</span><span class="va">H</span></span>
<span><span class="va">log.prior</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">dgamma</a></span><span class="op">(</span><span class="va">H.vals</span>, <span class="fl">1</span>, <span class="fl">1</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">log.like</span> <span class="op">&lt;-</span> <span class="va">search.result</span><span class="op">$</span><span class="va">log.like</span></span>
<span><span class="va">l.fx</span> <span class="op">&lt;-</span> <span class="va">log.prior</span> <span class="op">+</span> <span class="va">log.like</span></span>
<span><span class="va">pre.fx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">l.fx</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">l.fx</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">fx</span> <span class="op">&lt;-</span> <span class="va">pre.fx</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">pre.fx</span> <span class="op">*</span> <span class="op">(</span><span class="va">H.vals</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="va">H.vals</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">H.vals</span>, <span class="va">fx</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"l"</span>, xlab <span class="op">=</span> <span class="st">"H"</span>, ylab <span class="op">=</span> <span class="st">"Density"</span>,</span>
<span>  main <span class="op">=</span> <span class="st">"Posterior density for the unknown hyperparameter H"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="example1_files/figure-html/unnamed-chunk-16-1.png" width="672"></p>
</div>
<div class="section level2">
<h2 id="advanced-model-hospital-admissions-by-state">Advanced model: Hospital admissions by state<a class="anchor" aria-label="anchor" href="#advanced-model-hospital-admissions-by-state"></a>
</h2>
<p>For this model, we need the geographic information about Brazil, as
such, we will use some auxiliary packages, namely
<strong>geobr</strong>, <strong>tidyverse</strong>, <strong>sf</strong>
and <strong>spdep</strong>, although the <strong>kDGLM</strong> package
does not depend on them:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://ipeagit.github.io/geobr/" class="external-link">geobr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-spatial/spdep/" class="external-link">spdep</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">br.base</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ipeagit.github.io/geobr/reference/read_state.html" class="external-link">read_state</a></span><span class="op">(</span></span>
<span>  year <span class="op">=</span> <span class="fl">2019</span>,</span>
<span>  showProgress <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">plot.data</span> <span class="op">&lt;-</span> <span class="va">br.base</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span></span>
<span>    <span class="va">gastroBR</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">Date</span>, <span class="st">"%Y"</span><span class="op">)</span> <span class="op">==</span> <span class="st">"2019"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">UF</span>, <span class="va">Population</span>, <span class="va">Admissions</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">UF</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span></span>
<span>        Population <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">Population</span><span class="op">)</span>,</span>
<span>        Admissions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">Admissions</span><span class="op">)</span></span>
<span>      <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>abbrev_state <span class="op">=</span> <span class="va">UF</span><span class="op">)</span>,</span>
<span>    by <span class="op">=</span> <span class="st">"abbrev_state"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">plot.data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="va">Admissions</span> <span class="op">/</span> <span class="va">Population</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_fill_distiller</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="va">log</span><span class="op">[</span><span class="fl">10</span><span class="op">]</span> <span class="op">*</span> <span class="st">"(admissions/population)"</span><span class="op">)</span>,</span>
<span>    limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">4</span>, <span class="op">-</span><span class="fl">2.5</span><span class="op">)</span>,</span>
<span>    palette <span class="op">=</span> <span class="st">"RdYlBu"</span>,</span>
<span>    labels <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">.</span>, <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="example1_files/figure-html/unnamed-chunk-17-1.png" width="672"></p>
<p>Now we proceed to fitting the model itself. Let <span class="math inline">\(Y_{it}\)</span> be the number of hospital
admissions by gastroenteritis at time <span class="math inline">\(t\)</span> on region <span class="math inline">\(i\)</span>, we will assume the following
model:</p>
<p><span class="math display">\[
\begin{aligned}
Y_{it}|\eta_{it} &amp;\sim Poisson(\eta_{it})\\
\ln\{\eta_{it}\}&amp;=
\lambda_{it}=\theta_{1,t}+u_{i,t}+S_{i,t}+\epsilon_{i,t},\\
\theta_{1,t}&amp;= \theta_{1,t-1}+\theta_{2,t-1}+\omega_{1,t},\\
\theta_{2,t}&amp;= \theta_{2,t-1}+\omega_{2,t},\\
\begin{bmatrix}u_{i,t}\\ v_{i,t}\end{bmatrix} &amp;= R
\begin{bmatrix}u_{i,t-1}\\ v_{i,t-1}\end{bmatrix} + \begin{bmatrix}
\omega^{u}_{i,t}\\ \omega^{u}_{i,t}\end{bmatrix},\\
\epsilon_t &amp; \sim \mathcal{N}(0,\sigma_t^2),\\
S_{1,1},...,S_{r,1} &amp; \sim CAR(\tau),
\end{aligned}
\]</span> where <span class="math inline">\(r=27\)</span> is the number
of areas within our dataset.</p>
<p>Currently, the <strong>kDGLM</strong> package does not offer support
for sequential estimation of <span class="math inline">\(\tau\)</span>,
the parameter associated with the CAR prior. A study is being developed
to address this limitation. For now, we opt to conduct a sensitivity
analysis to determine an optimal value for <span class="math inline">\(tau\)</span> using the tools presented in
Subsection <a href="fitting.html#tools-for-sensitivity-analysis">Tools
for sensitivity analysis</a>. The optimal value found was <span class="math inline">\(\tau=0.005\)</span>.</p>
<p>Alternatively, if real-time inference is not a priority for the
analyst, a complete posterior for <span class="math inline">\(\tau\)</span> can be obtained by adapting the code
from Subsection <a href="fitting.html#sampling-and-hyper-parameter-estimation">Sampling and
hyper parameter estimation</a>, without incurring a high computational
cost.</p>
<p>Notice that we are assuming a very similar model to that which was
used in the initial_model, but here we have a common effect (or a global
effect) <span class="math inline">\(\theta_{1,t}\)</span> that equally
affects all regions, and a local effect <span class="math inline">\(S_{i,t}\)</span> that only affects region <span class="math inline">\(i\)</span> and evolves smoothly though time. Here
we chose a vague CAR prior <span class="citation">(<a href="#ref-banerjee2014hierarchical">Banerjee et al., 2014</a>; <a href="#ref-AlexCar">Schmidt and Nobre, 2018</a>)</span> for <span class="math inline">\(S_{i,t}\)</span>.</p>
<p>The proposed model can be fitted using the following code:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">adj.matrix</span> <span class="op">&lt;-</span> <span class="va">br.base</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/poly2nb.html" class="external-link">poly2nb</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/nb2mat.html" class="external-link">nb2mat</a></span><span class="op">(</span>style <span class="op">=</span> <span class="st">"B"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">CAR.structure</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/polynomial_block.html">polynomial_block</a></span><span class="op">(</span>rate <span class="op">=</span> <span class="fl">1</span>, D <span class="op">=</span> <span class="fl">0.9</span>, name <span class="op">=</span> <span class="st">"CAR"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/block_mult.html">block_mult</a></span><span class="op">(</span><span class="fl">27</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/block_rename.html">block_rename</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">gastroBR</span><span class="op">$</span><span class="va">UF</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/CAR_prior.html">CAR_prior</a></span><span class="op">(</span>scale <span class="op">=</span> <span class="st">"Scale"</span>, rho <span class="op">=</span> <span class="fl">1</span>, adj.matrix <span class="op">=</span> <span class="va">adj.matrix</span><span class="op">)</span></span>
<span></span>
<span><span class="va">shared.structure</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/polynomial_block.html">polynomial_block</a></span><span class="op">(</span></span>
<span>  RO <span class="op">=</span> <span class="fl">1</span>, AC <span class="op">=</span> <span class="fl">1</span>, AM <span class="op">=</span> <span class="fl">1</span>, RR <span class="op">=</span> <span class="fl">1</span>, PA <span class="op">=</span> <span class="fl">1</span>, AP <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  TO <span class="op">=</span> <span class="fl">1</span>, MA <span class="op">=</span> <span class="fl">1</span>, PI <span class="op">=</span> <span class="fl">1</span>, CE <span class="op">=</span> <span class="fl">1</span>, RN <span class="op">=</span> <span class="fl">1</span>, PB <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  PE <span class="op">=</span> <span class="fl">1</span>, AL <span class="op">=</span> <span class="fl">1</span>, SE <span class="op">=</span> <span class="fl">1</span>, BA <span class="op">=</span> <span class="fl">1</span>, MG <span class="op">=</span> <span class="fl">1</span>, ES <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  RJ <span class="op">=</span> <span class="fl">1</span>, SP <span class="op">=</span> <span class="fl">1</span>, PR <span class="op">=</span> <span class="fl">1</span>, SC <span class="op">=</span> <span class="fl">1</span>, RS <span class="op">=</span> <span class="fl">1</span>, MS <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  MT <span class="op">=</span> <span class="fl">1</span>, GO <span class="op">=</span> <span class="fl">1</span>, DF <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  order <span class="op">=</span> <span class="fl">2</span>, D <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.95</span>, <span class="fl">0.975</span><span class="op">)</span>,</span>
<span>  name <span class="op">=</span> <span class="st">"Common"</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/intervention.html">intervention</a></span><span class="op">(</span>time <span class="op">=</span> <span class="fl">124</span>, var.index <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span>, D <span class="op">=</span> <span class="fl">0.005</span><span class="op">)</span></span>
<span></span>
<span><span class="va">base.structure</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="../reference/harmonic_block.html">harmonic_block</a></span><span class="op">(</span>rate <span class="op">=</span> <span class="fl">1</span>, order <span class="op">=</span> <span class="fl">1</span>, period <span class="op">=</span> <span class="fl">12</span>, D <span class="op">=</span> <span class="fl">0.98</span>, name <span class="op">=</span> <span class="st">"Season"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/noise_block.html">noise_block</a></span><span class="op">(</span>rate <span class="op">=</span> <span class="fl">1</span>, R1 <span class="op">=</span> <span class="fl">0.007</span>, name <span class="op">=</span> <span class="st">"Noise"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/block_mult.html">block_mult</a></span><span class="op">(</span><span class="fl">27</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/block_rename.html">block_rename</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">gastroBR</span><span class="op">$</span><span class="va">UF</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">inputs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">shared.structure</span>, <span class="va">CAR.structure</span>, <span class="va">base.structure</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">uf</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">gastroBR</span><span class="op">$</span><span class="va">UF</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">reg.data</span> <span class="op">&lt;-</span> <span class="va">gastroBR</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">UF</span> <span class="op">==</span> <span class="va">uf</span><span class="op">)</span></span>
<span>  <span class="va">inputs</span><span class="op">[[</span><span class="va">uf</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Poisson.html">Poisson</a></span><span class="op">(</span>lambda <span class="op">=</span> <span class="va">uf</span>, data <span class="op">=</span> <span class="va">reg.data</span><span class="op">$</span><span class="va">Admissions</span>, offset <span class="op">=</span> <span class="va">reg.data</span><span class="op">$</span><span class="va">Population</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">inputs</span><span class="op">$</span><span class="va">Scale</span> <span class="op">&lt;-</span> <span class="fl">10</span><span class="op">**</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq.int</a></span><span class="op">(</span><span class="op">-</span><span class="fl">5</span>, <span class="fl">1</span>, l <span class="op">=</span> <span class="fl">21</span><span class="op">)</span></span>
<span><span class="va">model.search</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">fit_model</span>, <span class="va">inputs</span><span class="op">)</span></span>
<span><span class="va">fitted.model</span> <span class="op">&lt;-</span> <span class="va">model.search</span><span class="op">$</span><span class="va">model</span></span></code></pre></div>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fitted.model</span>, outcomes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"MG"</span>, <span class="st">"SP"</span>, <span class="st">"ES"</span>, <span class="st">"RJ"</span>, <span class="st">"CE"</span>, <span class="st">"BA"</span>, <span class="st">"RS"</span>, <span class="st">"SC"</span>, <span class="st">"AM"</span>, <span class="st">"AC"</span><span class="op">)</span>, lag <span class="op">=</span> <span class="fl">1</span>, plot.pkg <span class="op">=</span> <span class="st">"ggplot2"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span><span class="st">""</span>, values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span><span class="st">""</span>, values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">Serie</span>, ncol <span class="op">=</span> <span class="fl">2</span>, scale <span class="op">=</span> <span class="st">"free_y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="cn">NA</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"none"</span>, fill <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"top"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>â€©[1mâ€©[22mScale for â€©[32mcolourâ€©[39m is already present.
Adding another scale for â€©[32mcolourâ€©[39m, which will replace the existing scale.
â€©[1mâ€©[22mScale for â€©[32mfillâ€©[39m is already present.
Adding another scale for â€©[32mfillâ€©[39m, which will replace the existing scale.
â€©[1mâ€©[22mCoordinate system already present. Adding new coordinate system, which will
replace the existing one.</code></pre>
<div class="figure">
<img src="example1_files/figure-html/unnamed-chunk-19-1.png" alt="The time series of hospital admissions by gastroenteritis of some Brazilian states from 2010 to 2022. Notice that the proposed model can capture the general behavior of all series, while simultaneously capturing the dependence between regions through the shared component $\theta_{1,t}$ and the local effects $S_i$." width="672"><p class="caption">
The time series of hospital admissions by gastroenteritis of some
Brazilian states from 2010 to 2022. Notice that the proposed model can
capture the general behavior of all series, while simultaneously
capturing the dependence between regions through the shared component
<span class="math inline">\(\theta_{1,t}\)</span> and the local effects
<span class="math inline">\(S_i\)</span>.
</p>
</div>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">smoothed.values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">fitted.model</span><span class="op">)</span></span>
<span><span class="va">plot.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">labels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="st">"2010-01-01"</span> <span class="op">=</span> <span class="st">"(a) January, 2010"</span>,</span>
<span>  <span class="st">"2020-03-01"</span> <span class="op">=</span> <span class="st">"(b) March, 2020"</span>,</span>
<span>  <span class="st">"2020-04-01"</span> <span class="op">=</span> <span class="st">"(c) April, 2020"</span>,</span>
<span>  <span class="st">"2022-12-01"</span> <span class="op">=</span> <span class="st">"(d) December, 2022"</span></span>
<span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">date</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"2010-01-01"</span>, <span class="st">"2020-03-01"</span>, <span class="st">"2020-04-01"</span>, <span class="st">"2022-12-01"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">gastroBR</span><span class="op">$</span><span class="va">Date</span> <span class="op">==</span> <span class="va">date</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">plot.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>    <span class="va">plot.data</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span></span>
<span>      Date <span class="op">=</span> <span class="va">labels</span><span class="op">[[</span><span class="va">date</span><span class="op">]</span><span class="op">]</span>,</span>
<span>      Effect <span class="op">=</span> <span class="va">smoothed.values</span><span class="op">$</span><span class="va">lambda.mean</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">reg.data</span><span class="op">$</span><span class="va">UF</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, <span class="va">index</span><span class="op">]</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>,</span>
<span>      <span class="va">br.base</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">plot.data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">Effect</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">Date</span>, strip.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_fill_distiller</a></span><span class="op">(</span><span class="st">"$\\log_{10}$ rate"</span>,</span>
<span>    limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">6</span>, <span class="op">-</span><span class="fl">3</span><span class="op">)</span>,</span>
<span>    palette <span class="op">=</span> <span class="st">"RdYlBu"</span>,</span>
<span>    labels <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">.</span>, <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="example1_files/figure-html/unnamed-chunk-24-1.png" alt="The $\log_{10}$ hospital admissions rate by gastroenteritis in Brazilian states at 4 key moments: (a) January of 2010, were our data begins; (b) March of 2020, the month were the first case of COVID-19 was registered in Brazil and before public response; (c) April of 2020, the first month of the pandemic period; and (d) December of 2022, the end of the period of study and roughly 2 years after the beginning of the pandemic. Notice that from (a) to (b) 10 years had passed and we see that a steady and smoothly yearly reductions of hospital admissions led to a significantly reduction of the rate of hospital. In contrast, from (b) to (c), only 1 month had passed, but we see a reduction that, proportionally, is event greater than from (a) to (b). Lastly, from (c) to (d), after roughly 2 years, the rate of hospital admissions seems to be going back to what was seen in (c)." width="672"><p class="caption">
The <span class="math inline">\(\log_{10}\)</span> hospital admissions
rate by gastroenteritis in Brazilian states at 4 key moments: (a)
January of 2010, were our data begins; (b) March of 2020, the month were
the first case of COVID-19 was registered in Brazil and before public
response; (c) April of 2020, the first month of the pandemic period; and
(d) December of 2022, the end of the period of study and roughly 2 years
after the beginning of the pandemic. Notice that from (a) to (b) 10
years had passed and we see that a steady and smoothly yearly reductions
of hospital admissions led to a significantly reduction of the rate of
hospital. In contrast, from (b) to (c), only 1 month had passed, but we
see a reduction that, proportionally, is event greater than from (a) to
(b). Lastly, from (c) to (d), after roughly 2 years, the rate of
hospital admissions seems to be going back to what was seen in (c).
</p>
</div>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">labels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="st">"2015-01-01"</span> <span class="op">=</span> <span class="st">"January, 2015"</span>,</span>
<span>  <span class="st">"2019-12-01"</span> <span class="op">=</span> <span class="st">"December, 2019"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">plot.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">date</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"2015-01-01"</span>, <span class="st">"2019-12-01"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">gastroBR</span><span class="op">$</span><span class="va">Date</span> <span class="op">==</span> <span class="va">date</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">forecast.vals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">fitted.model</span>, lag <span class="op">=</span> <span class="fl">3</span>, t.eval <span class="op">=</span> <span class="va">index</span>, eval.pred <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">mean.pred</span> <span class="op">&lt;-</span> <span class="va">forecast.vals</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">Prediction</span></span>
<span>  <span class="va">reg.data</span> <span class="op">&lt;-</span> <span class="va">gastroBR</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Date</span> <span class="op">==</span> <span class="va">date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Tx <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="va">Admissions</span> <span class="op">/</span> <span class="va">Population</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">plot.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>    <span class="va">plot.data</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span></span>
<span>      Date <span class="op">=</span> <span class="va">labels</span><span class="op">[[</span><span class="va">date</span><span class="op">]</span><span class="op">]</span>,</span>
<span>      Effect <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="va">mean.pred</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="va">reg.data</span><span class="op">$</span><span class="va">Population</span><span class="op">)</span>,</span>
<span>      <span class="va">br.base</span>,</span>
<span>      Label <span class="op">=</span> <span class="st">"Prediction"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">plot.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>    <span class="va">plot.data</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span></span>
<span>      Date <span class="op">=</span> <span class="va">labels</span><span class="op">[[</span><span class="va">date</span><span class="op">]</span><span class="op">]</span>,</span>
<span>      Effect <span class="op">=</span> <span class="va">reg.data</span><span class="op">$</span><span class="va">Tx</span>, <span class="va">br.base</span>,</span>
<span>      Label <span class="op">=</span> <span class="st">"Observed"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">plot.data</span><span class="op">$</span><span class="va">Label</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">plot.data</span><span class="op">$</span><span class="va">Label</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">plot.data</span><span class="op">$</span><span class="va">Label</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">plot.data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">Effect</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="va">Label</span> <span class="op">~</span> <span class="va">Date</span>, strip.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_fill_distiller</a></span><span class="op">(</span><span class="st">"log10 rate"</span>,</span>
<span>    limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">5.5</span>, <span class="op">-</span><span class="fl">3.5</span><span class="op">)</span>,</span>
<span>    palette <span class="op">=</span> <span class="st">"RdYlBu"</span>,</span>
<span>    labels <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">.</span>, <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="example1_files/figure-html/unnamed-chunk-25-1.png" width="672">
Since there are <span class="math inline">\(27\)</span> regions, with
<span class="math inline">\(156\)</span> observations each, it is not
reasonably to show how our model performed for every combination of date
and location. We will limit ourselves to show some regions at all times
and all regions at some times The reader may use the code provided in
this document or in the vignette to fit this model and do a thoroughly
examination of the results. Moreover, here we focus only in the usage of
the <strong>kDGLM</strong> package and not in the epidemiological aspect
of the results.</p>
<p>Finally, about the computational cost, the initial model (that for
the total number of hospital admissions over time) took about <span class="math inline">\(0.11s\)</span> to fit and the advanced model took
<span class="math inline">\(4.24s\)</span>, which is within the expected
range, since the final model has <span class="math inline">\(27\)</span>
outcomes and <span class="math inline">\(110\)</span> latent states
that, when we consider that they all had temporal dynamic, yields <span class="math inline">\(17.160\)</span> parameters, from which the joint
distribution is obtained.</p>
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-banerjee2014hierarchical" class="csl-entry">
Banerjee, S., Carlin, B. P., and Gelfand, A. E. (2014). <em>Hierarchical
modeling and analysis for spatial data</em>. Chapman; Hall/CRC.
</div>
<div id="ref-ArtigoMultivar" class="csl-entry">
dos Santos, S. V., Junior, Alves, M. B., and Migon, H. S. (2024). An
efficient sequential approach for joint modelling of multiple time
series.
</div>
<div id="ref-datasus_data" class="csl-entry">
Ministry of Health, Brazil. (2023). <span>DATASUS</span> - department of
informatics of the unified health system. <a href="http://datasus.saude.gov.br" class="external-link uri">http://datasus.saude.gov.br</a>.
</div>
<div id="ref-covid_reduc" class="csl-entry">
Ribeiro, E. G., Pinheiro, P. C., Nascimento, B. R., Cacique, J. P. P.,
Teixeira, R. A., Nascimento, J. de S., â€¦ Malta, D. C. (2022). <a href="https://doi.org/10.1590/0037-8682-0264-2021" class="external-link">Impact of the
COVID-19 pandemic on hospital admissions for cardiovascular diseases in
a large brazilian urban center</a>. <em>Revista Da Sociedade Brasileira
de Medicina Tropical</em>, <em>55</em>, e0264â€“2021.
</div>
<div id="ref-AlexCar" class="csl-entry">
Schmidt, A. M., and Nobre, W. S. (2018). <a href="https://doi.org/10.1002/9781118445112.stat08048" class="external-link">Conditional
autoregressive (CAR) model</a>. In <em>Wiley StatsRef: Statistics
reference online</em>, pages 1â€“11. John Wiley &amp; Sons, Ltd.
</div>
<div id="ref-WestHarr-DLM" class="csl-entry">
West, M., and Harrison, J. (1997). <em>Bayesian forecasting and dynamic
models (springer series in statistics)</em>. Hardcover; Springer-Verlag.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Silvaneo Vieira dos Santos Junior, Mariane Branco Alves, HÃ©lio dos Santos Migon.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
