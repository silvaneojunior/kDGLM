<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="kDGLM">
<title>Space-time model hospital admissions from gastroenteritis • kDGLM</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Space-time model hospital admissions from gastroenteritis">
<meta property="og:description" content="kDGLM">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">kDGLM</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.3</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/example1.html">Space-time model hospital admissions from gastroenteritis</a>
    <a class="dropdown-item" href="../articles/fitting.html">Fitting and analysing models</a>
    <a class="dropdown-item" href="../articles/intro.html">kDGLM: an R package for Bayesian analysis of Dynamic Generialized Linear Models</a>
    <a class="dropdown-item" href="../articles/outcomes.html">Creation of model outcomes</a>
    <a class="dropdown-item" href="../articles/structures.html">Creation of model structures</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/silvaneojunior/kDGLM/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Space-time model hospital admissions from gastroenteritis</h1>
                        <h4 data-toc-skip class="author">Silvaneo V. dos
Santos Jr.</h4>
            
            <h4 data-toc-skip class="date">21 of February, 2024</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/silvaneojunior/kDGLM/blob/HEAD/vignettes/example1.Rmd" class="external-link"><code>vignettes/example1.Rmd</code></a></small>
      <div class="d-none name"><code>example1.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="table-of-contents">Table of contents<a class="anchor" aria-label="anchor" href="#table-of-contents"></a>
</h2>
<ol>
<li>
<details><summary><a href="intro.html">Introduction:</a> &gt;
</summary><ul>
<li>
<a href="intro.html#introduction">Introduction</a>
</li>
<li>
<a href="intro.html#notation">Notation</a>
</li>
</ul></details>
</li>
<li>
<details><summary><a href="structures.html">Creating the model structure:</a> &gt;
</summary><ul>
<li>
<a href="structures.html#a-structure-for-polynomial-trend-models">A
structure for polynomial trend models</a>
</li>
<li>
<a href="structures.html#a-structure-for-dynamic-regression-models">A
structure for dynamic regression models</a>
</li>
<li>
<a href="structures.html#a-structure-for-harmonic-trend-models">A
structure for harmonic trend models</a>
</li>
<li>
<a href="structures.html#a-structure-for-autoregresive-models">A
structure for autoregresive models</a>
</li>
<li>
<a href="structures.html#a-structure-for-overdispersed-models">A
structure for overdispersed models</a>
</li>
<li>
<a href="structures.html#handling-multiple-structural-blocks">Handling
multiple structural blocks</a>
</li>
<li>
<a href="structures.html#handling-multiple-linear-predictors">Handling
multiple linear predictors</a>
</li>
<li>
<a href="structures.html#handling-unknown-components-in-the-planning-matrix-f_t">Handling
unknown components in the planning matrix <span class="math inline">\(F_t\)</span></a>
</li>
<li>
<a href="structures.html#special-priors">Special priors</a>
</li>
</ul></details>
</li>
<li>
<details><summary><a href="outcomes.html">Creating the model outcome:</a> &gt;
</summary><ul>
<li>
<a href="outcomes.html#normal-case">Normal case</a>
</li>
<li>
<a href="outcomes.html#poisson-case">Poisson case</a>
</li>
<li>
<a href="outcomes.html#gamma-case">Gamma case</a>
</li>
<li>
<a href="outcomes.html#multinomial-case">Multinomial case</a>
</li>
<li>
<a href="outcomes.html#handling-multiple-outcomes">Handling multiple
outcomes</a>
</li>
</ul></details>
</li>
<li>
<details><summary><a href="fitting.html">Fitting and analysing models:</a> &gt;
</summary><ul>
<li>
<a href="fitting.html#filtering-and-smoothing">Filtering and
smoothing</a>
</li>
<li>
<a href="fitting.html#extracting-components">Extracting components</a>
</li>
<li>
<a href="fitting.html#forecasting">Forecasting</a>
</li>
<li>
<a href="fitting.html#intervention-and-monitoring">Intervention and
monitoring</a>
</li>
<li>
<a href="fitting.html#tools-for-sensibility-analysis">Tools for
sensibility analysis</a>
</li>
<li>
<a href="fitting.html#sampling-and-hyper-parameter-estimation">Sampling
and hyper parameter estimation</a>
</li>
</ul></details>
</li>
<li>
<details><summary>
Advanced examples:&gt;
</summary><ul><li>
<a href="example1.html">Space-time model hospital admissions from
gastroenteritis</a>
</li></ul></details>
</li>
</ol>
</div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>In this example we model number of hospital admissions from
gastroenteritis in Brazil from 2010 to 2022. Our package provides the
<code>gatroBR</code> dataset with the pertinent data for our models,
which includes:</p>
<ul>
<li>UF: The abbreviated state name.</li>
<li>Date: The date of the observation. Note that the day is only a
placeholder, as we are dealing with monthly reports.</li>
<li>Admissions: The number hospital admissions that were reported in
that combination of state and date.</li>
<li>The estimated population in that combination of state and date (to
be used as a offset).</li>
</ul>
<p>Supplementary informations can be found in the documentation (see
<code><a href="../reference/gastroBR.html">help(gastroBR)</a></code>).</p>
</div>
<div class="section level2">
<h2 id="initial-model-total-hospital-admissions">Initial model: Total hospital admissions<a class="anchor" aria-label="anchor" href="#initial-model-total-hospital-admissions"></a>
</h2>
<p>We will start with a model for the total number of hospital
admissions over time in Brazil, i.e., a temporal model that does not
considers the effects of each state.</p>
<p><img src="example1_files/figure-html/unnamed-chunk-2-1.png" width="700"></p>
<p>Notice that theres a consistent trend of (log) linear decay of the
rate of hospital admissions over time, until April of 2020, when there
is an abrupt reduction of hospital admission duo to the pandemic of
COVID-19, which is then followed by what seems to be a return to the
previous level (more observations would be necessary to be sure). We can
also note that the data has a clear seasonal pattern, which have a
period of 12 months (1 year).</p>
<p>We begin with a very simply model. Let <span class="math inline">\(Y_t\)</span> be the total number of hospital
admissions on Brazil at time <span class="math inline">\(t\)</span>.
Assume that:</p>
<p><span class="math display">\[
\begin{aligned}
Y_t|\eta_t &amp;\sim Poisson(\eta_t)\\
\ln{\eta_t}&amp;=\lambda_t=\theta_{1,t}\\
\theta_{1,t}&amp;=\theta_{1,t-1}+\theta_{2,t-1}+\omega_{1,t}\\
\theta_{2,t}&amp;=\theta_{2,t-1}+\omega_{2,t}.\\
\end{aligned}
\]</span></p>
<p>First we define the model structure:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">structure</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/polynomial_block.html">polynomial_block</a></span><span class="op">(</span></span>
<span>  rate <span class="op">=</span> <span class="fl">1</span>, order <span class="op">=</span> <span class="fl">2</span>, D <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.95</span>, <span class="fl">0.975</span><span class="op">)</span>,</span>
<span>  name <span class="op">=</span> <span class="st">"Trend"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Then we define the outcome:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">outcome</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Poisson.html">Poisson</a></span><span class="op">(</span></span>
<span>  lambda <span class="op">=</span> <span class="st">"rate"</span>,</span>
<span>  data <span class="op">=</span> <span class="va">data.year</span><span class="op">$</span><span class="va">Admissions</span>,</span>
<span>  offset <span class="op">=</span> <span class="va">data.year</span><span class="op">$</span><span class="va">Population</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Then we fit the model:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fitted.model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_model.html">fit_model</a></span><span class="op">(</span><span class="va">structure</span>, <span class="va">outcome</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fitted.model</span><span class="op">)</span></span></code></pre></div>
<pre><code>Fitted DGLM with 1 outcomes.

distributions:
    Series.1: Poisson

Coeficients (smoothed) at time 156:
            Estimate Std. Error   t value Pr(&gt;|t|)
Trend.Level -10.49460    0.00377 -2784.39712   &lt;1e-12 *** 
Trend.Slope  -0.00806    0.00019   -41.95112   &lt;1e-12 *** 
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

---
One-step-ahead prediction
Log-likelihood        :  -24560.91910
Interval Score        :   52492.80142
Mean Abs. Scaled Error:       1.31369
Relative abs. Error   :       0.17520
Mean Abs. Error       :    1501.65306
Mean Squared Error    :  3.691e+06
---</code></pre>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fitted.model</span>, plot.pkg <span class="op">=</span> <span class="st">"base"</span><span class="op">)</span></span></code></pre></div>
<p><img src="example1_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<pre><code><span><span class="cn">NULL</span></span></code></pre>
<p>Clearly the model described above is too simply to explain the data,
in particular, it does not take into account any form of seasonal
pattern. Let us proceed then by assuming the following model:</p>
<p><span class="math display">\[
\begin{aligned}
Y_t|\eta_t &amp;\sim Poisson(\eta_t)\\
\ln{\eta_t}&amp;=\lambda_t=\theta_{1,t}+\theta_{3,t}\\
\theta_{1,t}&amp;=\theta_{1,t-1}+\theta_{2,t-1}+\omega_{1,t}\\
\theta_{2,t}&amp;=\theta_{2,t-1}+\omega_{2,t},\\
\begin{bmatrix}\theta_{3,t}\\\theta_{4,t}\end{bmatrix}&amp;=R\begin{bmatrix}\theta_{3,t}\\\theta_{4,t}\end{bmatrix}+\begin{bmatrix}\omega_{3,t}\\\omega_{4,t}\end{bmatrix}
\end{aligned}
\]</span></p>
<p>Where <span class="math inline">\(R\)</span> is a rotation matrix
with angle <span class="math inline">\(\frac{2\pi}{12}\)</span>, such
that <span class="math inline">\(R^{12}\)</span> is equal to the
identity matrix.</p>
<p>To define the structure of that model we can use the
<code>harmonic_block</code> function alongside the
<code>polynomial_block</code> function:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">structure</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/polynomial_block.html">polynomial_block</a></span><span class="op">(</span></span>
<span>  rate <span class="op">=</span> <span class="fl">1</span>, order <span class="op">=</span> <span class="fl">2</span>, D <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.95</span>, <span class="fl">0.975</span><span class="op">)</span>,</span>
<span>  name <span class="op">=</span> <span class="st">"Trend"</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/harmonic_block.html">harmonic_block</a></span><span class="op">(</span></span>
<span>    rate <span class="op">=</span> <span class="fl">1</span>, period <span class="op">=</span> <span class="fl">12</span>, D <span class="op">=</span> <span class="fl">0.98</span>,</span>
<span>    name <span class="op">=</span> <span class="st">"Season"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>Then we fit the model (using the previously defined outcome):</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fitted.model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_model.html">fit_model</a></span><span class="op">(</span><span class="va">structure</span>, <span class="va">outcome</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fitted.model</span><span class="op">)</span></span></code></pre></div>
<pre><code>Fitted DGLM with 1 outcomes.

distributions:
    Series.1: Poisson

Coeficients (smoothed) at time 156:
            Estimate Std. Error   t value Pr(&gt;|t|)
Trend.Level -10.50216    0.00394 -2663.44603   &lt;1e-12 *** 
Trend.Slope  -0.00788    0.00022   -36.22919   &lt;1e-12 *** 
Season.Main   0.13913    0.00240    57.87650   &lt;1e-12 *** 
Season.Aux    0.02138    0.00235     9.09009   &lt;1e-12 *** 
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

---
One-step-ahead prediction
Log-likelihood        :  -17311.70077
Interval Score        :   41412.16312
Mean Abs. Scaled Error:       0.64692
Relative abs. Error   :       0.15308
Mean Abs. Error       :    1319.68499
Mean Squared Error    :  2.985e+06
---</code></pre>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fitted.model</span>, plot.pkg <span class="op">=</span> <span class="st">"base"</span><span class="op">)</span></span></code></pre></div>
<p><img src="example1_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<pre><code><span><span class="cn">NULL</span></span></code></pre>
<p>Notice that this change significantly improves all metrics provided
by the model summary, which indicates that we are going in the right
direction. We leave as an exercise for the reader to test different
orders for the harmonic block.</p>
<p>The previous model could capture the mean behavior of the series
reasonably well, still, two deficiencies of that model standout: First,
the overconfidence in the predictions, evidenced by the particularly
thin credibility interval; And second, the difficulty the model had to
adapt to the pandemic period.</p>
<p>The first problem comes from the fact that we are using a Poisson
model, which implies that <span class="math inline">\(Var[Y_t|\eta_t]=\mathbb{E}[Y_t|\eta_t]\)</span>,
which means that <span class="math inline">\(Var[Y_t]=\mathbb{E}[Var[Y_t|\eta_t]]+Var[\mathbb{E}[Y_t|\eta_t]]=\mathbb{E}[\eta_t]+Var[\eta_t]\)</span>.
For latter observations we expect that <span class="math inline">\(Var[\eta_t]\)</span> to be relatively small, as
such, the variance of <span class="math inline">\(Y_t\)</span> should be
very close to its mean after a reasonable amount of observations. In
this scenario, the coefficient of variation, defined as <span class="math inline">\(\frac{\sqrt{Var[Y_t]}}{\mathbb{E}[Y_t]}\)</span>
goes to <span class="math inline">\(0\)</span> as <span class="math inline">\(\mathbb{E}[Y_t]\)</span> grows, in particular, for
data in the scale we are working with in this particular problem, we
would expect a very low coefficient of variation if the Poisson model
were adequate, but that is not what we observe. This phenomena is called
<em>overdipersion</em> and is a well known problem in literature. To
solve it, we can include a block representing a white noise that is
added to the linear predictor at each time, but does not affect previous
or future observation, so as to capture the overdipersion. In this case,
we will assume the following model:</p>
<p><span class="math display">\[
\begin{aligned}
Y_t|\eta_t &amp;\sim Poisson(\eta_t)\\
\ln{\eta_t}&amp;=\lambda_t=\theta_{1,t}+\theta_{3,t}+\epsilon_t\\
\theta_{1,t}&amp;=\theta_{1,t-1}+\theta_{2,t-1}+\omega_{1,t}\\
\theta_{2,t}&amp;=\theta_{2,t-1}+\omega_{2,t},\\
\begin{bmatrix}\theta_{3,t}\\\theta_{4,t}\end{bmatrix}&amp;=R\begin{bmatrix}\theta_{3,t}\\\theta_{4,t}\end{bmatrix}+\begin{bmatrix}\omega_{3,t}\\\omega_{4,t}\end{bmatrix}\\
\epsilon_t &amp; \sim \mathcal{N}(0,\sigma_t^2)
\end{aligned}
\]</span></p>
<p>This structure can be defined using the <code>noise_block</code>
function, alongside the previously used functions:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">structure</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/polynomial_block.html">polynomial_block</a></span><span class="op">(</span></span>
<span>  rate <span class="op">=</span> <span class="fl">1</span>, order <span class="op">=</span> <span class="fl">2</span>, D <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.95</span>, <span class="fl">0.975</span><span class="op">)</span>,</span>
<span>  name <span class="op">=</span> <span class="st">"Trend"</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/harmonic_block.html">harmonic_block</a></span><span class="op">(</span></span>
<span>    rate <span class="op">=</span> <span class="fl">1</span>, period <span class="op">=</span> <span class="fl">12</span>, D <span class="op">=</span> <span class="fl">0.98</span>,</span>
<span>    name <span class="op">=</span> <span class="st">"Season"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/noise_block.html">noise_block</a></span><span class="op">(</span>rate <span class="op">=</span> <span class="fl">1</span>, name <span class="op">=</span> <span class="st">"Noise"</span><span class="op">)</span></span></code></pre></div>
<p>For the second problem, that of slow adaptation after the start of
the pandemic. The ideal approach would be to make an intervention,
increasing the uncertainty about the latent states at the beginning of
the pandemic period and allowing our model to quickly adapt to the new
scenario <span class="citation">(see <a href="#ref-WestHarr-DLM">West
and Harrison 1997, chap. 11</a>)</span>. We recommend this approach when
we already expect a change of behavior in a certain time, even before
looking at the data (which is exactly the case). Still, for didactic
purposes, we will first present how the automated monitoring can also be
used to solve this same problem. In general, we recommend the automated
monitoring approach when we do <strong>not</strong> known if or
<strong>when</strong> a change of behavior happened before looking at
the data, i.e., we do not known of any particular event that we expect
to impact our outcome.</p>
<p>Following what was presented in the subsection about automated
monitoring, we can use the following code to fit our model:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">structure</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/polynomial_block.html">polynomial_block</a></span><span class="op">(</span></span>
<span>  rate <span class="op">=</span> <span class="fl">1</span>, order <span class="op">=</span> <span class="fl">2</span>, D <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.95</span>, <span class="fl">0.975</span><span class="op">)</span>,</span>
<span>  name <span class="op">=</span> <span class="st">"Trend"</span>, monitoring <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">TRUE</span>, <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/harmonic_block.html">harmonic_block</a></span><span class="op">(</span></span>
<span>    rate <span class="op">=</span> <span class="fl">1</span>, period <span class="op">=</span> <span class="fl">12</span>, D <span class="op">=</span> <span class="fl">0.98</span>,</span>
<span>    name <span class="op">=</span> <span class="st">"Season"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/noise_block.html">noise_block</a></span><span class="op">(</span>rate <span class="op">=</span> <span class="fl">1</span>, name <span class="op">=</span> <span class="st">"Noise"</span><span class="op">)</span></span></code></pre></div>
<p>Notice that we set the <code>monitoring</code> of the
<code>polynomial_block</code> to <code>c(TRUE,TRUE)</code>. By default,
the <code>polynomial_block</code> function only enable the monitoring of
its first component (the level), but, by the previous plot, it is very
clear that the pandemic affected both the level and the slope of the
average number of hospital admissions, as such, we would like to monitor
both parameters.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># To activate the automated monitoring it is enough to set the p.monit argument to a valid value</span></span>
<span><span class="va">fitted.model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_model.html">fit_model</a></span><span class="op">(</span><span class="va">structure</span>, <span class="va">outcome</span>, p.monit <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fitted.model</span><span class="op">)</span></span></code></pre></div>
<pre><code>Fitted DGLM with 1 outcomes.

distributions:
    Series.1: Poisson

Coeficients (smoothed) at time 156:
            Estimate Std. Error   t value Pr(&gt;|t|)
Trend.Level -10.29011    0.05268 -195.32261   &lt;1e-12 *** 
Trend.Slope   0.01578    0.00523    3.01764    0.003 ** 
Season.Main   0.11250    0.02759    4.07744 4.55e-05 *** 
Season.Aux   -0.00854    0.02773   -0.30786    0.758   
Noise.Var     0.00000    0.12242    0.00000    1.000   
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

---
One-step-ahead prediction
Log-likelihood        :   -1243.03595
Interval Score        :   10808.12766
Mean Abs. Scaled Error:       0.60043
Relative abs. Error   :       0.12306
Mean Abs. Error       :    1224.83848
Mean Squared Error    :  2.887e+06
---</code></pre>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fitted.model</span>, plot.pkg <span class="op">=</span> <span class="st">"base"</span><span class="op">)</span></span></code></pre></div>
<p><img src="example1_files/figure-html/unnamed-chunk-10-1.png" width="700"></p>
<pre><code><span><span class="cn">NULL</span></span></code></pre>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fitted.model</span>, lag <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, plot.pkg <span class="op">=</span> <span class="st">"base"</span><span class="op">)</span></span></code></pre></div>
<p><img src="example1_files/figure-html/unnamed-chunk-10-2.png" width="700"></p>
<pre><code><span><span class="cn">NULL</span></span></code></pre>
<p>The summary presented above shows a massive improvement in the
comparison metrics with the new changes introduced, moreover, the
automated monitoring detected the exact moment where the series <span class="math inline">\(Y_t\)</span> changed behavior, which allowed the
model to immediately adapt to the pandemic period.</p>
<p>One aspect of the model that may bother the reader is the exceedingly
high uncertainty at the first observations. This behavior is duo to our
approach to the estimation of the variance of the white noise introduced
by the <code>noise_block</code> function (see the associated
documentation for details), which can be a bit too sensitive to bad
prior specification at the initial steps. As such, we highly recommend
the user to do a sensibility analysis to choose the initial variance of
the white noise:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">structure</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/polynomial_block.html">polynomial_block</a></span><span class="op">(</span></span>
<span>  rate <span class="op">=</span> <span class="fl">1</span>, order <span class="op">=</span> <span class="fl">2</span>, D <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.95</span>, <span class="fl">0.975</span><span class="op">)</span>,</span>
<span>  name <span class="op">=</span> <span class="st">"Trend"</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/harmonic_block.html">harmonic_block</a></span><span class="op">(</span></span>
<span>    rate <span class="op">=</span> <span class="fl">1</span>, period <span class="op">=</span> <span class="fl">12</span>, D <span class="op">=</span> <span class="fl">0.98</span>,</span>
<span>    name <span class="op">=</span> <span class="st">"Season"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/noise_block.html">noise_block</a></span><span class="op">(</span>rate <span class="op">=</span> <span class="fl">1</span>, R1 <span class="op">=</span> <span class="st">"H"</span>, name <span class="op">=</span> <span class="st">"Noise"</span><span class="op">)</span> <span class="co"># Setting the initial variance as a unknown parameter</span></span>
<span></span>
<span><span class="va">structure</span> <span class="op">&lt;-</span> <span class="va">structure</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/intervention.html">intervention</a></span><span class="op">(</span>time <span class="op">=</span> <span class="fl">124</span>, var.index <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span>, D <span class="op">=</span> <span class="fl">0.005</span><span class="op">)</span></span>
<span></span>
<span><span class="va">search.model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/search_model.html">search_model</a></span><span class="op">(</span></span>
<span>  <span class="va">structure</span>, <span class="va">outcome</span>,</span>
<span>  lag <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, <span class="co"># Using the model likelihood (f(y|M)) as the comparisson metric.</span></span>
<span>  search.grid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>H <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq.int</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.1</span>, l <span class="op">=</span> <span class="fl">101</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">fitted.model</span> <span class="op">&lt;-</span> <span class="va">search.model</span><span class="op">$</span><span class="va">model</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fitted.model</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fitted.model</span>, plot.pkg <span class="op">=</span> <span class="st">"base"</span><span class="op">)</span></span></code></pre></div>
<p><img src="example1_files/figure-html/unnamed-chunk-11-1.png" width="700"></p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fitted.model</span>, lag <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, plot.pkg <span class="op">=</span> <span class="st">"base"</span><span class="op">)</span></span></code></pre></div>
<p><img src="example1_files/figure-html/unnamed-chunk-11-2.png" width="700"></p>
<p>Notice that, this time around, we chose to make an intervention at
the beginning of the pandemic, instead of an automated approach. As
mentioned before, this approach is preferable in this scenario, since we
were aware that the pandemic would affect our outcome before even
looking at the data.</p>
<p>Again, the new changes improve the comparison metrics even further,
leading to the conclusion that our last model is the best among those
presented until now. We highly encourage the reader to run this example
and experiment with some of the options our package offers, but that
were not explored, such as changing the discount factors used in each
block, the order of the blocks, adding/removing structural components,
etc..</p>
<p>As a last side note, the user may not like the approach of choosing a
specific value for the initial variance of the white noise introduced by
the <code>noise_block</code>. Indeed, one may wish to define a prior
distribution for this parameter and estimate it along with the others.
While we will not detail this approach for the sake of brevity (since
our package does not support it directly), we would like to point out
that we do offer tools to facilitate this procedure:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">search.result</span> <span class="op">&lt;-</span> <span class="va">search.model</span><span class="op">$</span><span class="va">search.data</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">search.model</span><span class="op">$</span><span class="va">search.data</span><span class="op">$</span><span class="va">H</span><span class="op">)</span>, <span class="op">]</span></span>
<span></span>
<span><span class="va">H.vals</span> <span class="op">&lt;-</span> <span class="va">search.result</span><span class="op">$</span><span class="va">H</span></span>
<span><span class="va">log.prior</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">dgamma</a></span><span class="op">(</span><span class="va">H.vals</span>, <span class="fl">1</span>, <span class="fl">1</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">log.like</span> <span class="op">&lt;-</span> <span class="va">search.result</span><span class="op">$</span><span class="va">log.like</span></span>
<span><span class="va">l.fx</span> <span class="op">&lt;-</span> <span class="va">log.prior</span> <span class="op">+</span> <span class="va">log.like</span></span>
<span><span class="va">pre.fx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">l.fx</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">l.fx</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">fx</span> <span class="op">&lt;-</span> <span class="va">pre.fx</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">pre.fx</span> <span class="op">*</span> <span class="op">(</span><span class="va">H.vals</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="va">H.vals</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">H.vals</span>, <span class="va">fx</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"l"</span>, xlab <span class="op">=</span> <span class="st">"H"</span>, ylab <span class="op">=</span> <span class="st">"Density"</span>,</span>
<span>  main <span class="op">=</span> <span class="st">"Posterior density for the unknown hyperparameter H"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="example1_files/figure-html/unnamed-chunk-12-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="advanced-model-hospital-admissions-by-state">Advanced model: Hospital admissions by state<a class="anchor" aria-label="anchor" href="#advanced-model-hospital-admissions-by-state"></a>
</h2>
<p>For this model, we need the geographic information about Brazil, as
such, we will use some auxiliary packages, namely <code>geobr</code>,
<code>tidyverse</code>, <code>sf</code> and <code>spdep</code>, although
the <code>kDGLM</code> package does not depend on them:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ipeaGIT/geobr" class="external-link">geobr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-spatial/spdep/" class="external-link">spdep</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">br.base</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/geobr/man/read_state.html" class="external-link">read_state</a></span><span class="op">(</span></span>
<span>  year <span class="op">=</span> <span class="fl">2019</span>,</span>
<span>  showProgress <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">plot.data</span> <span class="op">&lt;-</span> <span class="va">br.base</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span></span>
<span>    <span class="va">gastroBR</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">Date</span>, <span class="st">"%Y"</span><span class="op">)</span> <span class="op">==</span> <span class="st">"2019"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">UF</span>, <span class="va">Population</span>, <span class="va">Admissions</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">UF</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span></span>
<span>        Population <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">Population</span><span class="op">)</span>,</span>
<span>        Admissions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">Admissions</span><span class="op">)</span></span>
<span>      <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>abbrev_state <span class="op">=</span> <span class="va">UF</span><span class="op">)</span>,</span>
<span>    by <span class="op">=</span> <span class="st">"abbrev_state"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">plot.data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="va">Admissions</span> <span class="op">/</span> <span class="va">Population</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_fill_distiller</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="va">log</span><span class="op">[</span><span class="fl">10</span><span class="op">]</span> <span class="op">*</span> <span class="st">"(admissions/population)"</span><span class="op">)</span>,</span>
<span>    limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">4</span>, <span class="op">-</span><span class="fl">2.5</span><span class="op">)</span>,</span>
<span>    palette <span class="op">=</span> <span class="st">"RdYlBu"</span>,</span>
<span>    labels <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">.</span>, <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="example1_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
<p>First lets evaluate if there is any evidence of spacial
autocorrelation within our data. For that, following common practices in
literature, we proceed by applying Moran’s test for each year and then
to total number of admissions:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">for</span> <span class="op">(</span><span class="va">ano</span> <span class="kw">in</span> <span class="fl">2010</span><span class="op">:</span><span class="fl">2022</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">ref.br</span> <span class="op">&lt;-</span> <span class="va">br.base</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span></span>
<span>      <span class="va">gastroBR</span> <span class="op">|&gt;</span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">Date</span>, <span class="st">"%Y"</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">ano</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">UF</span>, <span class="va">Population</span>, <span class="va">Admissions</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">UF</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span></span>
<span>          Population <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">Population</span><span class="op">)</span>,</span>
<span>          Admissions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">Admissions</span><span class="op">)</span></span>
<span>        <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>abbrev_state <span class="op">=</span> <span class="va">UF</span><span class="op">)</span>,</span>
<span>      by <span class="op">=</span> <span class="st">"abbrev_state"</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>  <span class="va">moran.test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/moran.test.html" class="external-link">moran.test</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="va">ref.br</span><span class="op">$</span><span class="va">Admissions</span> <span class="op">/</span> <span class="va">ref.br</span><span class="op">$</span><span class="va">Population</span><span class="op">)</span>,</span>
<span>    <span class="va">ref.br</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/poly2nb.html" class="external-link">poly2nb</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/nb2listw.html" class="external-link">nb2listw</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">$</span><span class="va">p.value</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">ano</span>, <span class="st">" - "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">moran.test</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<pre><code>[1] "2010 - 0.1595"
[1] "2011 - 0.0584"
[1] "2012 - 0.0291"
[1] "2013 - 0.0093"
[1] "2014 - 0.067"
[1] "2015 - 0.2144"
[1] "2016 - 0.086"
[1] "2017 - 0.0406"
[1] "2018 - 0.0519"
[1] "2019 - 0.016"
[1] "2020 - 0.0063"
[1] "2021 - 5e-04"
[1] "2022 - 0.0033"</code></pre>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ref.br</span> <span class="op">&lt;-</span> <span class="va">br.base</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span></span>
<span>    <span class="va">gastroBR</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">UF</span>, <span class="va">Population</span>, <span class="va">Admissions</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">UF</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span></span>
<span>        Population <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">Population</span><span class="op">)</span>,</span>
<span>        Admissions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">Admissions</span><span class="op">)</span></span>
<span>      <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>abbrev_state <span class="op">=</span> <span class="va">UF</span><span class="op">)</span>,</span>
<span>    by <span class="op">=</span> <span class="st">"abbrev_state"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">moran.test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/moran.test.html" class="external-link">moran.test</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="va">ref.br</span><span class="op">$</span><span class="va">Admissions</span> <span class="op">/</span> <span class="va">ref.br</span><span class="op">$</span><span class="va">Population</span><span class="op">)</span>,</span>
<span>  <span class="va">ref.br</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/poly2nb.html" class="external-link">poly2nb</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/nb2listw.html" class="external-link">nb2listw</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">$</span><span class="va">p.value</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Total"</span>, <span class="st">" - "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">moran.test</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>[1] "Total - 0.0268"</code></pre>
<p>As we had hoped, we have significant evidence of spatial
autocorrelation in several years and for the total. Here we are not
<strong>formally</strong> applying Moran’s test, but instead looking at
its result to get some intuition about the problem.</p>
<p>Now we proceed to fitting the model itself. Let <span class="math inline">\(Y_{it}\)</span> be the number of hospital
admissions by gastroenteritis at time <span class="math inline">\(t\)</span> on region <span class="math inline">\(i\)</span>, we will assume the following
model:</p>
<p><span class="math display">\[
\begin{aligned}
Y_{it}|\eta_{it} &amp;\sim Poisson(\eta_{it})\\
\ln\{\eta_{it}\}&amp;=
\lambda_{it}=\theta_{1,t}+u_{i,t}+S_{i,t}+\epsilon_{i,t},\\
\theta_{1,t}&amp;= \theta_{1,t-1}+\theta_{2,t-1}+\omega_{1,t},\\
\theta_{2,t}&amp;= \theta_{2,t-1}+\omega_{2,t},\\
\begin{bmatrix}u_{i,t}\\ v_{i,t}\end{bmatrix} &amp;= R
\begin{bmatrix}u_{i,t-1}\\ v_{i,t-1}\end{bmatrix} + \begin{bmatrix}
\omega^{u}_{i,t}\\ \omega^{u}_{i,t}\end{bmatrix},\\
\epsilon_t &amp; \sim \mathcal{N}(0,\sigma_t^2),\\
S_{1,1},...,S_{r,1} &amp; \sim CAR(100),
\end{aligned}
\]</span> where <span class="math inline">\(r=27\)</span> is the number
of areas within our dataset.</p>
<p>Notice that we are assuming a very similar model to that which was
used in subsection <span class="math inline">\(\ref{initial_model}\)</span>, but here we have a
common effect (or a global effect) <span class="math inline">\(\theta_{1,t}\)</span> that equally affects all
regions, and a local effect <span class="math inline">\(S_{i,t}\)</span>
that only affects region <span class="math inline">\(i\)</span> and
evolves smoothly though time. Here we chose a vague CAR prior <span class="citation">(<a href="#ref-AlexCar">Schmidt and Nobre
2018</a>)</span> for <span class="math inline">\(S_{i,t}\)</span>.</p>
<p>The proposed model can be fitted using the following code.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">adj.matrix</span> <span class="op">&lt;-</span> <span class="va">ref.br</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/poly2nb.html" class="external-link">poly2nb</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/nb2mat.html" class="external-link">nb2mat</a></span><span class="op">(</span>style <span class="op">=</span> <span class="st">"B"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">CAR.structure</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/polynomial_block.html">polynomial_block</a></span><span class="op">(</span>rate <span class="op">=</span> <span class="fl">1</span>, D <span class="op">=</span> <span class="fl">0.8</span>, name <span class="op">=</span> <span class="st">"CAR"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/block_mult.html">block_mult</a></span><span class="op">(</span><span class="fl">27</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/block_rename.html">block_rename</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">gastroBR</span><span class="op">$</span><span class="va">UF</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/CAR_prior.html">CAR_prior</a></span><span class="op">(</span>scale <span class="op">=</span> <span class="fl">9</span>, rho <span class="op">=</span> <span class="fl">1</span>, adj.matrix <span class="op">=</span> <span class="va">adj.matrix</span><span class="op">)</span></span>
<span></span>
<span><span class="va">shared.structure</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/polynomial_block.html">polynomial_block</a></span><span class="op">(</span></span>
<span>  RO <span class="op">=</span> <span class="fl">1</span>, AC <span class="op">=</span> <span class="fl">1</span>, AM <span class="op">=</span> <span class="fl">1</span>, RR <span class="op">=</span> <span class="fl">1</span>, PA <span class="op">=</span> <span class="fl">1</span>, AP <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  TO <span class="op">=</span> <span class="fl">1</span>, MA <span class="op">=</span> <span class="fl">1</span>, PI <span class="op">=</span> <span class="fl">1</span>, CE <span class="op">=</span> <span class="fl">1</span>, RN <span class="op">=</span> <span class="fl">1</span>, PB <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  PE <span class="op">=</span> <span class="fl">1</span>, AL <span class="op">=</span> <span class="fl">1</span>, SE <span class="op">=</span> <span class="fl">1</span>, BA <span class="op">=</span> <span class="fl">1</span>, MG <span class="op">=</span> <span class="fl">1</span>, ES <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  RJ <span class="op">=</span> <span class="fl">1</span>, SP <span class="op">=</span> <span class="fl">1</span>, PR <span class="op">=</span> <span class="fl">1</span>, SC <span class="op">=</span> <span class="fl">1</span>, RS <span class="op">=</span> <span class="fl">1</span>, MS <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  MT <span class="op">=</span> <span class="fl">1</span>, GO <span class="op">=</span> <span class="fl">1</span>, DF <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  order <span class="op">=</span> <span class="fl">2</span>, D <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.95</span>, <span class="fl">0.975</span><span class="op">)</span>,</span>
<span>  name <span class="op">=</span> <span class="st">"Common"</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/intervention.html">intervention</a></span><span class="op">(</span>time <span class="op">=</span> <span class="fl">124</span>, var.index <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span>, D <span class="op">=</span> <span class="fl">0.005</span><span class="op">)</span></span>
<span></span>
<span><span class="va">base.structure</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="../reference/harmonic_block.html">harmonic_block</a></span><span class="op">(</span>rate <span class="op">=</span> <span class="fl">1</span>, order <span class="op">=</span> <span class="fl">1</span>, period <span class="op">=</span> <span class="fl">12</span>, D <span class="op">=</span> <span class="fl">0.98</span>, name <span class="op">=</span> <span class="st">"Season"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/noise_block.html">noise_block</a></span><span class="op">(</span>rate <span class="op">=</span> <span class="fl">1</span>, R1 <span class="op">=</span> <span class="fl">0.007</span>, name <span class="op">=</span> <span class="st">"Noise"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/block_mult.html">block_mult</a></span><span class="op">(</span><span class="fl">27</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/block_rename.html">block_rename</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">gastroBR</span><span class="op">$</span><span class="va">UF</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">inputs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">shared.structure</span>, <span class="va">CAR.structure</span>, <span class="va">base.structure</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">uf</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">gastroBR</span><span class="op">$</span><span class="va">UF</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">reg.data</span> <span class="op">&lt;-</span> <span class="va">gastroBR</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">UF</span> <span class="op">==</span> <span class="va">uf</span><span class="op">)</span></span>
<span>  <span class="va">inputs</span><span class="op">[[</span><span class="va">uf</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Poisson.html">Poisson</a></span><span class="op">(</span>lambda <span class="op">=</span> <span class="va">uf</span>, data <span class="op">=</span> <span class="va">reg.data</span><span class="op">$</span><span class="va">Admissions</span>, offset <span class="op">=</span> <span class="va">reg.data</span><span class="op">$</span><span class="va">Population</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">fitted.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">fit_model</span>, <span class="va">inputs</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fitted.data</span>, lag <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, plot.pkg <span class="op">=</span> <span class="st">"ggplot2"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">Serie</span>, ncol <span class="op">=</span> <span class="fl">3</span>, scale <span class="op">=</span> <span class="st">"free_y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="cn">NA</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span><span class="st">""</span>, values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="fl">27</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span><span class="st">""</span>, values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="fl">27</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"none"</span>, fill <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"top"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code> [1m [22mCoordinate system already present. Adding new coordinate system, which will
replace the existing one.
 [1m [22mScale for  [32mcolour [39m is already present.
Adding another scale for  [32mcolour [39m, which will replace the existing scale.
 [1m [22mScale for  [32mfill [39m is already present.
Adding another scale for  [32mfill [39m, which will replace the existing scale.</code></pre>
<div class="figure">
<img src="example1_files/figure-html/unnamed-chunk-16-1.png" alt="The time series of hospital admissions by gastroenteritis of some Brazilian states from 2010 to 2022. Notice that the proposed model can capture the general behavior of all series, while simultaneously capturing the dependence between regions through the shared component $\theta_{1,t}$ and the local effects $S_i$." width="768"><p class="caption">
The time series of hospital admissions by gastroenteritis of some
Brazilian states from 2010 to 2022. Notice that the proposed model can
capture the general behavior of all series, while simultaneously
capturing the dependence between regions through the shared component
<span class="math inline">\(\theta_{1,t}\)</span> and the local effects
<span class="math inline">\(S_i\)</span>.
</p>
</div>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">CAR.var.index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"CAR"</span>, <span class="va">fitted.data</span><span class="op">$</span><span class="va">var.labels</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">plot.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">labels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="st">"2010-01-01"</span> <span class="op">=</span> <span class="st">"(a) January, 2010"</span>,</span>
<span>  <span class="st">"2020-03-01"</span> <span class="op">=</span> <span class="st">"(b) March, 2020"</span>,</span>
<span>  <span class="st">"2020-04-01"</span> <span class="op">=</span> <span class="st">"(c) April, 2020"</span>,</span>
<span>  <span class="st">"2022-12-01"</span> <span class="op">=</span> <span class="st">"(d) December, 2022"</span></span>
<span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">date</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"2010-01-01"</span>, <span class="st">"2020-03-01"</span>, <span class="st">"2020-04-01"</span>, <span class="st">"2022-12-01"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">gastroBR</span><span class="op">$</span><span class="va">Date</span> <span class="op">==</span> <span class="va">date</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">plot.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>    <span class="va">plot.data</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span></span>
<span>      Date <span class="op">=</span> <span class="va">labels</span><span class="op">[[</span><span class="va">date</span><span class="op">]</span><span class="op">]</span>,</span>
<span>      Effect <span class="op">=</span> <span class="va">fitted.data</span><span class="op">$</span><span class="va">mts</span><span class="op">[</span><span class="fl">1</span>, <span class="va">index</span><span class="op">]</span> <span class="op">+</span> <span class="va">fitted.data</span><span class="op">$</span><span class="va">mts</span><span class="op">[</span><span class="va">CAR.var.index</span>, <span class="va">index</span><span class="op">]</span>,</span>
<span>      <span class="va">br.base</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">plot.data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">Effect</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">Date</span>, strip.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_fill_distiller</a></span><span class="op">(</span><span class="st">"log rate of admissions\nper habitant"</span>,</span>
<span>    limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">12.7</span>, <span class="op">-</span><span class="fl">7.7</span><span class="op">)</span>,</span>
<span>    palette <span class="op">=</span> <span class="st">"RdYlBu"</span>,</span>
<span>    labels <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">.</span>, <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="example1_files/figure-html/unnamed-chunk-22-1.png" alt="The $\log_{10}$ hospital admissions rate by gastroenteritis in Brazilian states at 4 key moments: (a) January of 2010, were our data begins; (b) March of 2020, the month were the first case of COVID-19 was registered in Brazil and before public response; (c) April of 2020, the first month of the pandemic period; and (d) December of 2022, the end of the period of study and roughly 2 years after the beginning of the pandemic. Notice that from (a) to (b) 10 years had passed and we see that a steady and smoothly yearly reductions of hospital admissions led to a significantly reduction of the rate of hospital. In contrast, from (b) to (c), only 1 month had passed, but we see a reduction that, proportionally, is event greater than from (a) to (b). Lastly, from (c) to (d), after roughly 2 years, the rate of hospital admissions seems to be going back to what was seen in (c)." width="700"><p class="caption">
The <span class="math inline">\(\log_{10}\)</span> hospital admissions
rate by gastroenteritis in Brazilian states at 4 key moments: (a)
January of 2010, were our data begins; (b) March of 2020, the month were
the first case of COVID-19 was registered in Brazil and before public
response; (c) April of 2020, the first month of the pandemic period; and
(d) December of 2022, the end of the period of study and roughly 2 years
after the beginning of the pandemic. Notice that from (a) to (b) 10
years had passed and we see that a steady and smoothly yearly reductions
of hospital admissions led to a significantly reduction of the rate of
hospital. In contrast, from (b) to (c), only 1 month had passed, but we
see a reduction that, proportionally, is event greater than from (a) to
(b). Lastly, from (c) to (d), after roughly 2 years, the rate of
hospital admissions seems to be going back to what was seen in (c).
</p>
</div>
<p>Finally, about the computational cost, the initial model (that for
the total number of hospital admissions over time) took about <span class="math inline">\(0.11s\)</span> to fit and the advanced model took
<span class="math inline">\(4.24s\)</span>, which is within the expected
range, since the final model has <span class="math inline">\(27\)</span>
outcomes and <span class="math inline">\(110\)</span> latent states
that, when we consider that they all had temporal dynamic, yields <span class="math inline">\(17.160\)</span> parameters, from which our package
computes the joint distribution.</p>
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-AlexCar" class="csl-entry">
Schmidt, Alexandra M., and Widemberg S. Nobre. 2018. <span>“Conditional
Autoregressive (CAR) Model.”</span> In <em>Wiley StatsRef: Statistics
Reference Online</em>, 1–11. John Wiley &amp; Sons, Ltd.
https://doi.org/<a href="https://doi.org/10.1002/9781118445112.stat08048" class="external-link">https://doi.org/10.1002/9781118445112.stat08048</a>.
</div>
<div id="ref-WestHarr-DLM" class="csl-entry">
West, Mike, and Jeff Harrison. 1997. <em>Bayesian Forecasting and
Dynamic Models (Springer Series in Statistics)</em>. Hardcover;
Springer-Verlag.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Silvaneo dos Santos.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
